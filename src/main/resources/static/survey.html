<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><title>问卷</title><link rel="stylesheet" href="/static/style.css"><script src="/static/api.js"></script></head><body>
<header>
  <div class="logo">USTB Survey</div>
  <nav>
    <a href="/static/index.html">首页</a>
    <a href="/static/shared-surveys.html">公开问卷</a>
    <a href="/static/my-surveys.html">我的问卷</a>
  </nav>
</header>
<main>
  <section class="panel stack">
    <div>
      <h2 id="title" style="margin:0 0 4px">问卷</h2>
      <p id="desc" class="muted" style="margin:0"></p>
    </div>
    <form id="answerForm" class="stack"></form>
    <div class="actions">
      <button id="submitBtn">提交</button>
      <button id="batchBtn" type="button" class="secondary">批量提交 JSON</button>
    </div>
    <pre id="result" class="code-block"></pre>
    <div class="muted" style="font-size:12px;">提示: 可直接分享此链接给他人答题；无需登录。</div>
  </section>
</main>
<script>
AppBoot.waitAPI(()=>{
  if(typeof $!=='function'){ console.error('[survey] $ 未定义'); return; }
  const id=new URLSearchParams(location.search).get('id');
  if(!id){ toast('缺少 id','error'); return; }
  let survey;
  function normalizeSurvey(raw){
    const s = {};
    s.id = raw.surveyId || raw.id;
    s.title = raw.surveyTitle || raw.title || '(未命名问卷)';
    s.description = raw.surveyDescription || raw.description || '';
    s.questions = (raw.questions||[]).map(q=>{
      const nq = {};
      nq.id = q.questionId || q.id;
      nq.title = q.questionContent || q.title || '';
      // 类型: 后端 int(1=单选 2=文本 ...)，前端使用 single/text
      const t = q.questionType!=null? q.questionType : q.type;
      if(typeof t==='number'){
        if(t===2) nq.type='text';
        else if(t===3) nq.type='multi';
        else nq.type='single';
      } else {
        nq.type = t || 'single';
      }
      if(!nq.type && raw.questionTypeDescription){
        const desc = String(raw.questionTypeDescription);
        if(desc.includes('多选')) nq.type='multi';
        else if(desc.includes('文本')) nq.type='text';
      }
      // 满分（如果有规则结构）
      if(q.score_rule && (q.score_rule.full_score!=null)) nq.fullScore = q.score_rule.full_score;
      else if(q.fullScore!=null) nq.fullScore = q.fullScore;
      // 选项：后端可能是 [{optionLabel, optionContent}] 或 [{label,content}] 或字符串数组
      const opts = q.options || [];
        nq.options = opts.map(o => {
          if (typeof o === 'string') return { label: o, content: o };
          return {
            label: o.optionLabel || o.label || o.option_label || o.content || o.optionContent || '选项',
            content: o.optionContent || o.content || o.option_content || o.label || ''
          };
        });
      return nq;
    });
    return s;
  }
  async function load(){ try{ const raw=await API.getSurvey(id); survey=normalizeSurvey(raw); render(); }catch(e){ toast('加载失败'); } }
  function render(){
    $('#title').textContent=survey.title; $('#desc').textContent=survey.description;
    const form=$('#answerForm'); form.innerHTML='';
    survey.questions.forEach(q=>{
      const field=document.createElement('div'); field.className='question-field';
      field.innerHTML = `<div class="q-title"><strong>${q.title}</strong>${q.fullScore!=null?` <span style='opacity:.7'>(满分${q.fullScore})</span>`:''}</div>`;
      if(q.type==='single' || q.type==='multi'){
          q.options.forEach((opt, idx) => {
            const effLabel = (opt.label && String(opt.label).trim()) || String.fromCharCode(65 + idx);
            const optVal = effLabel.toUpperCase();
            const display = effLabel + (opt.content && opt.content !== opt.label ? (' - ' + opt.content) : '');
            const idAttr = 'q' + q.id + '_' + optVal;
            const row = document.createElement('label');
            row.className = 'option-row';
            const inp = document.createElement('input');
            inp.type = q.type === 'single' ? 'radio' : 'checkbox';
            inp.name = 'q_' + q.id + (q.type === 'multi' ? '[]' : '');
            inp.value = optVal;
            inp.id = idAttr;
            const text = document.createElement('span');
            text.textContent = display;
            row.appendChild(inp);
            row.appendChild(text);
            field.appendChild(row);
          });
      } else if(q.type==='text'){
        field.innerHTML+=`<textarea name="q_${q.id}" rows="2"></textarea>`;
      } else if(q.type==='number'){
        field.innerHTML+=`<input type="number" name="q_${q.id}">`;
      }
      form.appendChild(field);
    });
  }
  document.getElementById('submitBtn').addEventListener('click', async e=>{
    e.preventDefault(); if(!survey) return; const entries=[];
    survey.questions.forEach(q=>{
      const name='q_'+q.id;
      if(q.type==='multi'){
        const vals=[...document.querySelectorAll(`input[name='${name}[]']:checked`)].map(i=>i.value);
        entries.push({question_id:q.id, answer:vals});
      } else if(q.type==='single'){
        const v=document.querySelector(`input[name='${name}']:checked`);
        entries.push({question_id:q.id, answer:v? v.value:''});
      } else {
        const v=document.querySelector(`[name='${name}']`).value;
        entries.push({question_id:q.id, answer:v});
      }
    });
    try{
      const r=await API.batchSubmit(id, entries);
      const total = r.total_score ?? r.totalScore ?? r.score ?? r.total;
      const details = r.details || r.items || r.result || null;
      $('#result').textContent = '得分: '+ total + (details? ('\n详情:'+JSON.stringify(details,null,2)) : '');
    }catch(err){ toast('提交失败 '+(err.data?.error||'')); }
  });
  document.getElementById('batchBtn').addEventListener('click', ()=>{
    const text=prompt('粘贴批量提交 JSON 数组: 例如 [{"question_id":1,"answer":"A"}]');
    if(!text) return;
    try{
      const arr=JSON.parse(text);
      API.batchSubmit(id, arr).then(r=>{
        const total = r.total_score ?? r.totalScore ?? r.score ?? r.total;
        $('#result').textContent='得分: '+ total;
      }).catch(e=>toast('失败'));
    }catch(e){ toast('JSON 解析失败'); }
  });
  load();
  // 问卷公开访问：仅在已登录时显示用户导航（但不再有顶部 header，这里忽略）
  if(API.token()){
    // 可根据需要在面板内追加用户信息（当前需求为隐藏顶部 bar，故暂不显示）
  }
});
</script>
</body></html>